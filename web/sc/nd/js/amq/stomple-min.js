/*
* @license
* @preserve,
* The MIT License
* --
* Copyright (c) <2010> Karl Krukow <karl.krukow@gmail.com>
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in
* all copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
* THE SOFTWARE.
* --
*
* @package Stomple
* @author Karl Krukow <karl.krukow@gmail.com>
* @copyright 2010 Karl Krukow <kkr@trifork.com>
* @license http://opensource.org/licenses/mit-license.php MIT License
* @link http://github.com/krukow/stomple
* @version 0.95 (RC1)
*/
(function(){var c=this,d=function(s,v){var u=typeof s[v];return u==="function"||(!!(u==="object"&&s[v]))||u==="unknown"},a,k=function(){},j=d(c,"console"),l=j&&d(c.console,"log"),p=j&&d(c.console,"warn"),b=j&&d(c.console,"info"),n;if(!d(c,"WebSocket")){if(p){c.console.warn(c.Stomple?"Stomple already defined.":"Stomple: WebSockets not available")}c.Stomple=c.Stomple||false;return}if(String.prototype.trim){n=function(s){return s.trim()}}else{n=function(u){u=u.replace(/^\s\s*/,"");var s=/\s/,t=u.length;while(s.test(u.charAt(--t))){}return u.slice(0,t+1)}}if(!Object.create){Object.create=(function(){function s(){}return function(w,u){s.prototype=w;var t=new s(),v;if(u){for(v in u){if(u.hasOwnProperty(v)){t[v]=u[v].value}}}return t}})()}var e=function(v,t,u){var s;if(u){for(s in t){if(t.hasOwnProperty(s)){v[s]={value:t[s]}}}}else{for(s in t){if(t.hasOwnProperty(s)){v[s]=t[s]}}}return v};var i=function(s){if(!s){return 0}var t=encodeURIComponent(s),u=/%/g,v=t.length;while(u.exec(t)){v-=2}return v};var g=function(t,s){if(!t||s<=0){return 0}var u=0,v=0,w;while(v<s){w=t.charCodeAt(u);if(w<128){v+=1}else{w=encodeURIComponent(w.charAt(u));v+=w.length/3}u+=1}if(v===s){return u}else{return u-1}};var q="\u0000",r="\n";var f={command:null,headers:null,body:null,toString:function(){var s=this.command,t,u=this.headers;s+=r;if(u){for(t in u){if(u.hasOwnProperty(t)){s+=t;s+=":";s+=u[t];s+=r}}}s+=r;if(this.body){s+=this.body}s+=q;return s}};var m=function(s){var u={};if(s.command){u.command={value:s.command}}if(s.headers){u.headers={value:s.headers}}if(s.body){u.body={value:s.body}}var t=Object.create(f,u);return t};var o={timeout:8000,autoConnect:true,autoContentLength:true,autoReceipt:true,closeOnError:true,disconnectOnClose:true,onConnect:k,connectFailed:k,onError:k,onReceipt:k,socketOpen:k,socketMessage:k,socketClose:k,socketError:k,connected:false,websocket:null,session:null,connectConfig:null,connectTimeoutId:null,msgid:null,transid:null,pending:null,subscribers:null,transactions:null,url:null,destination:null,login:null,passcode:null,connect:function(s){if(this.connected){throw new Error("Called connect when in connected state.")}this.connectConfig=s;this.doConnect(s)},send:function(s){this.checkConnectAndDo(this.doSend,s)},subscribe:function(s){this.checkConnectAndDo(this.doSubscribe,s)},unsubscribe:function(s){this.checkConnectAndDo(this.doUnsubscribe,s)},begin:function(s){this.checkConnectAndDo(this.doBegin,s)},commit:function(s){this.checkConnectAndDo(this.doCommit,s)},ack:function(s){this.checkConnectAndDo(this.doAck,s)},abort:function(s){this.checkConnectAndDo(this.doAbort,s)},disconnect:function(s){this.checkConnectAndDo(this.doDisconnect,s)},close:function(s){s=s||{};var t=this,u=function(){t.close()};if(this.connected&&(this.disconnectOnClose||s.disconnectOnClose)){this.disconnect({success:u,failure:u})}if(this.websocket){this.websocket.close()}},checkConnectAndDo:function(u,s){var t=this;if(!this.connected){if(this.autoConnect||s&&s.autoConnect){this.connect(Object.create(s,{success:{value:function(){u.call(t,s)}}}))}else{throw new Error("Not connected (and autoConnect is false)")}}else{u.call(this,s)}},doConnect:function(t){var u=this,s=u.websocket=new WebSocket(u.url),v=m({command:"CONNECT",headers:{login:t.login||u.login,passcode:t.passcode||u.passcode}});if(a.debug&&l){console.log(">>>>\n"+v.toString())}u.connectTimeoutId=setTimeout(function(){u.handleConnectFailed({reason:"timeout",frame:v,websocket:s})},t.timeout||u.timeout);s.onopen=function(){u.handleOpen(v,t)};s.onmessage=function(w){u.handleMessage(w)};s.onclose=function(w){u.handleClose(w)};s.onerror=function(){u.handleError()}},transmitFrame:function(u){var s=u.spec,y=u.command,v=this,x=this.makeClientFrame(y,s),z,w=typeof s.failure==="function",t=x.headers.receipt;if(typeof u.beforeSend==="function"){u.beforeSend(x)}if(a.debug&&l){console.log(">>>>\n"+x.toString())}if(this.websocket.send(x.toString())){if(typeof u.onSend==="function"){u.onSend(x)}if(t){z=setTimeout(function(){if(typeof u.onTimeout==="function"){u.onTimeout(x)}if(t){delete v.pending[t]}if(w){s.failure({reason:"timeout",frame:x,websocket:this.websocket})}},s.timeout||this.timeout);if(typeof u.makeReceiptHandler==="function"){this.pending[t]=u.makeReceiptHandler(s,z,x)}else{this.pending[t]=this.makeReceiptHandler(s,z,x)}}else{if(typeof s.success==="function"){s.success(x)}}return x}else{if(typeof u.onFail==="function"){u.onFail(x)}if(w){s.failure({reason:"io",frame:x,websocket:this.websocket})}return false}},doSend:function(s){return this.transmitFrame({command:"SEND",spec:s})},doSubscribe:function(s){var t=this;return this.transmitFrame({command:"SUBSCRIBE",spec:s,onTimeout:function(v){var u=v.headers.destination;t.removeSubscriber(u,s)},onSend:function(v){var u=v.headers.destination;t.subscribers[u]=t.subscribers[u]||[];t.subscribers[u].push(s)},makeReceiptHandler:function(u,x,w){var v=w.headers.destination;return t.makeReceiptHandler(Object.create(u,{failure:{value:function(y){t.removeSubscriber(v,u);if(typeof u.failure==="function"){u.failure(y)}}}}),x,w)}})},doUnsubscribe:function(s){var t=this;return this.transmitFrame({command:"UNSUBSCRIBE",spec:s,beforeSend:function(v){var u=v.headers.destination;t.removeSubscriber(u,s)}})},doBegin:function(s){var u=this,v,t;v=s.transaction;if(typeof v==="undefined"||v===null){v=this.session+"-t-"+(++this.transid)}t={id:v,msgs:[]};return this.transmitFrame({command:"BEGIN",spec:s,beforeSend:function(w){w.headers.transaction=v},onSend:function(w){u.transactions.push(t)},onTimeout:function(w){u.removeTransaction(t)},makeReceiptHandler:function(w,y,x){return u.makeReceiptHandler(Object.create(w,{failure:{value:function(z){u.removeTransaction(t);if(typeof w.failure==="function"){w.failure(z)}}}}),y,x)}})},doCommit:function(s){var t=this;return this.transmitFrame({command:"COMMIT",spec:s,beforeSend:function(u){t.transactions.pop()}})},doAck:function(s){var t=this;return this.transmitFrame({command:"ACK",spec:s})},doAbort:function(s){var t=this;return this.transmitFrame({command:"ABORT",spec:s,beforeSend:function(u){t.transactions.pop()}})},doDisconnect:function(s){var t=this;return this.transmitFrame({command:"DISCONNECT",spec:s,beforeSend:function(u){t.connected=false;t.connectConfig=null}})},handleConnect:function(t){var s=t.frame;if(this.connectTimeoutId){clearTimeout(this.connectTimeoutId);this.connectTimeoutId=null}this.connected=true;this.session=s.headers.session||"";this.msgid=0;this.transid=0;this.onConnect(t);if(this.connectConfig&&typeof this.connectConfig.success==="function"){this.connectConfig.success(t)}},handleConnectFailed:function(s){if(this.connectTimeoutId){clearTimeout(this.connectTimeoutId);this.connectTimeoutId=null}this.connectFailed(s);if(this.connectConfig&&typeof this.connectConfig.failure==="function"){this.connectConfig.failure(s)}this.connected=false;this.session=null;this.msgid=null;this.transid=null;if(this.closeOnError){this.websocket.close()}},handleOpen:function(t,s){if(this.socketOpen(t)===false){this.websocket.close();return}this.websocket.send(t.toString())},handleClose:function(s){this.socketClose(s);if(this.connectTimeoutId){clearTimeout(this.connectTimeoutId);if(this.connectConfig&&typeof this.connectConfig.failure==="function"){this.connectConfig.failure(s)}}this.destroy()},handleError:function(){if(this.socketError()!==false&&this.closeOnError){if(this.connectTimeoutId){clearTimeout(this.connectTimeoutId);if(this.connectConfig&&typeof this.connectConfig.failure==="function"){this.connectConfig.failure()}}if(this.websocket){this.websocket.close()}}},handleMessage:function(u){if(this.socketMessage(u)===false){return}var J=u.data,D=J.indexOf(r),v,C=J.substring(0,D),I=J.substring(D+1),B=null,H=/(.+):(.+)/g,x=I.indexOf("\n\n"),t=I.substring(0,x),s={},E,z,A=I.substring(x+2),w,y;while((B=H.exec(t))){s[n(B[1])]=n(B[2])}w=s["content-length"];if(w){try{w=parseInt(w,10)}catch(G){w=null}}if(w){A=A.substring(0,g(A,w))}else{D=A.indexOf(q);A=A.substring(0,(D===-1)?A.length:D)}var F=m({command:C,headers:s,body:A});if(a.debug&&l){console.log("<<<<\n"+F.toString())}switch(C){case"CONNECTED":this.handleConnect({frame:F,websocket:this.websocket});break;case"MESSAGE":E=this.subscribers[s.destination];if(E){for(D=0,v=E.length;D<v;D+=1){z=E[D];z.handler.call(z.thisObj||c,F)}}break;case"RECEIPT":y=this.pending[s["receipt-id"]||"0"];if(y&&typeof y.success==="function"){y.success(y.frame)}if(typeof this.onReceipt==="function"){this.onReceipt(y.frame)}break;case"ERROR":y=this.pending[s["receipt-id"]||"0"];if(y&&typeof y.failure==="function"){y.failure(y.frame)}if(typeof this.onError==="function"){this.onError(y.frame)}break}},makeClientFrame:function(x,t){var v={destination:t.destination||this.destination},s={command:x,headers:v,body:t.body},w=t.options||{},u;if((w.receipt!==false)&&(this.autoReceipt||w.receipt)){v.receipt=w.receipt||this.session+"-m-"+(++this.msgid)}if(x!=="SUBSCRIBE"&&(w.contentLength!==false)&&(this.autoContentLength||(typeof w.contentLength==="number"||w.contentLength))){if(typeof w.contentLength==="number"){v["content-length"]=""+w.contentLength}else{v["content-length"]=""+i(t.body)}}if((w.transaction!==false)&&(this.transactions.length>0||w.transaction)){v.transaction=w.transaction||this.transactions[this.transactions.length-1].id}if(w.headers){e(v,w.headers)}return m(s)},makeReceiptHandler:function(s,u,t){return{success:function(){clearTimeout(u);if(typeof s.success==="function"){s.success(t)}},failure:function(v){clearTimeout(u);if(typeof s.failure==="function"){s.failure(v)}},frame:t}},removeSubscriber:function(t,v){var u=this.subscribers[t],w;if(u){w=u.length;while(w--){if(u[w]===v){u.splice(w,1);return v}}}return false},removeTransaction:function(u){var s=this.transactions,v=s.length;while(v--){if(s[v]===u){s.splice(v,1);return u}}return false},removeTransactionById:function(t){var s=this.transactions,u=s.length;while(u--){if(s[u].id===t){t=s[u];s.splice(u,1);return t}}return false},destroy:function(){this.connected=false;this.session=null;this.msgid=null;this.transid=null;this.websocket=null;this.connectConfig=null;this.connectTimeoutId=null;this.pending=null;this.subscribers=null;this.transactions=null;this.url=null;this.destination=null;this.login=null;this.passcode=null}};var h=function(t){var u=t.url,s=t.destination;if(!u||typeof(u=u.valueOf())!=="string"){throw TypeError("Must supply url of type string when calling create_client")}var v={pending:{value:[]},subscribers:{value:[]},transactions:{value:[]},login:{value:""},passcode:{value:""}};return Object.create(o,e(v,t,true))};a={create_client:h,ClientPrototype:o,FramePrototype:f,debug:false};c.Stomple=a})();